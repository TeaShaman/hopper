<html>
    <head>
        <link rel='stylesheet' href='/static/hopper/scheduler.min.css' />
        <link rel='stylesheet' href='/static/hopper/lib/fullcalendar.min.css' />
        <script src='/static/hopper/lib/moment.min.js'></script>
        <script src='/static/hopper/lib/jquery.min.js'></script>
        <script src='/static/hopper/lib/jquery-ui.min.js'></script>
        <script src='/static/hopper/lib/fullcalendar.min.js'></script>
        <script src='/static/hopper/scheduler.min.js'></script>
        <script>
            $(document).ready(function() {
                $(document).ajaxSend(function(event, xhr, settings) {
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie != '') {
                            var cookies = document.cookie.split(';');
                            for (var i = 0; i < cookies.length; i++) {
                                var cookie = $.trim(cookies[i]);
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                });
                $('#calendar').fullCalendar({
                    schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                    drop: function(date, jsEvent, ui, resourceId) {
                        console.log('drop', date.format(), resourceId)
                        //$(this).remove();
                    },
                    droppable: true,
                    events: {
                        url: '/api/v1/events/?has_time=true'
                    },
                    eventDataTransform: function(event) {
                        event.url = '/admin/hopper/event/'+event.id+'/change';
                        return event;
                    },
                    editable: true,
                    eventDrop: function( event, delta, revertFunc, jsEvent, ui, view) {
                        console.log('eventDrop', event);
                        //on drop, ajax update this event via API
                        $.ajax({
                            url: "/api/v1/events/" +event.id,
                            type: "PATCH",
                            data: JSON.stringify({
                                id: event.id,
                                start: event.start.format(),
                                end: event.end.format(),
                                resourceId: event.resourceId
                            }),
                            dataType: 'json',
                            contentType: 'application/json; charset=UTF-8',
                            success: function() { $('#status').text(event.title +" was saved successfully") },
                            error: function() { alert("Failure"); revertFunc() }
                        });
                    },
                    eventReceive: function (event) {
                        console.log('eventReceive', event);
                    },
                    defaultView: 'agendaDay',
                    forceEventDuration: true,
                    resourceLabelText: 'Rooms',
                    resources: {
                        url: '/api/v1/rooms/',
                        error: function() {
                            $('#status').text("Unable to load rooms");
                        }
                    }
                })
                $.ajax({
                    dataType: "json",
                    url: "/api/v1/events/?has_time=false",
                    success: function(data) {
                        var target = $('#unscheduled');
                        $.each(data, function() {
                            var div = $("<div>OLD TEXT</div>");
                            div.text(this.title);
                            div.data('event', {
                                id: this.id,
                                title: this.title
                            });
                            div.draggable({zIndex: 999, revert: true});
                            target.append(div);
                        });
                    }
                });
            })
        </script>
    </head>
    <body>
        <div id="status">
        </div>
        <div id="unscheduled">
        </div>
        <div id="calendar">
        </div>
    </body>
</html>
